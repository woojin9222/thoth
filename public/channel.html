<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>UChat Channel</title>
    <link rel="stylesheet" href="/style.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="app">
      <div id="chat">
        <div id="notice">ğŸ“¢ ê³µì§€: í™˜ì˜í•©ë‹ˆë‹¤!</div>
        <div id="messages"></div>
        <div style="display: flex; margin-top: 10px">
          <input id="input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
          <button onclick="send()">ì „ì†¡</button>
        </div>
      </div>
      <div id="users">
        <h3>ğŸ§‘ ìœ ì € ëª©ë¡</h3>
        <ul id="userList"></ul>
      </div>
      <div
        id="userMenu"
        style="
          display: none;
          position: absolute;
          background: white;
          border: 1px solid #ccc;
          padding: 5px;
          font-size: 14px;
          z-index: 1000;
        "
      ></div>
    </div>
    <script>
      const socket = io();
      const url = new URL(window.location.href);
      let isAdmin = false;
      let muted = false;

      const room = window.location.pathname.replace("/", "") || "default";
      const nickname = prompt("ë‹‰ë„¤ì„ ì…ë ¥") || "ìµëª…";
      let password = "";

      const isFirst = confirm("ğŸ’¡ ì´ ë°©ì„ ì²˜ìŒ ìƒì„±í•˜ì‹œë‚˜ìš”?");
      if (isFirst) {
        password = prompt("ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”");
      }

      socket.emit("join", { room, nickname, password });

      socket.on("adminGranted", () => {
        isAdmin = true;
        alert("ğŸ‰ ê´€ë¦¬ì ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
      });

      socket.on("adminDenied", () => {
        alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
      });

      socket.on("message", ({ nickname, text }) => {
        const el = document.createElement("div");
        el.innerText = `${nickname}: ${text}`;
        document.getElementById("messages").appendChild(el);
      });

      socket.on("userList", (users) => {
        const ul = document.getElementById("userList");
        ul.innerHTML = "";
        users.forEach((user) => {
          const li = document.createElement("li");
          li.innerText = user.nickname;
          li.onclick = (e) => showUserMenu(e, user.nickname);
          ul.appendChild(li);
        });
      });

      socket.on("muted", () => {
        muted = true;
        alert("ğŸ”‡ ë‹¹ì‹ ì€ ì±„íŒ…ê¸ˆì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      });

      socket.on("privateMessage", ({ from, message }) => {
        alert(`ğŸ’Œ ${from}ë‹˜ì˜ ê·“ì†ë§: ${message}`);
      });

      function showUserMenu(event, targetNickname) {
        const menu = document.getElementById("userMenu");
        menu.style.display = "block";
        menu.style.left = `${event.pageX}px`;
        menu.style.top = `${event.pageY}px`;

        menu.innerHTML = isAdmin
          ? `
        <div onclick="mention('${targetNickname}')">ë©˜ì…˜</div>
        <div onclick="mute('${targetNickname}')">ì±„íŒ…ê¸ˆì§€</div>
        <div onclick="kick('${targetNickname}')">ê°•í‡´</div>
      `
          : `
        <div onclick="mention('${targetNickname}')">ë©˜ì…˜</div>
        <div onclick="whisper('${targetNickname}')">ê·“ì†ë§</div>
      `;
      }

      function mention(name) {
        document.getElementById("input").value = `@${name} `;
        document.getElementById("userMenu").style.display = "none";
      }

      function whisper(name) {
        const msg = prompt(`${name}ì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€:`);
        if (msg)
          socket.emit("privateMessage", {
            to: name,
            from: nickname,
            message: msg,
          });
        document.getElementById("userMenu").style.display = "none";
      }

      function mute(name) {
        socket.emit("muteUser", { to: name });
        document.getElementById("userMenu").style.display = "none";
      }

      function kick(name) {
        alert(`(ì˜ˆì‹œ) ${name}ì„ ê°•í‡´í–ˆìŠµë‹ˆë‹¤.`);
        document.getElementById("userMenu").style.display = "none";
      }

      function send() {
        const input = document.getElementById("input");
        const msg = input.value.trim();
        if (!msg) return;

        if (msg === "/ë¡œê·¸ì¸") {
          const pw = prompt("ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
          if (pw) socket.emit("loginAdmin", { room, password: pw });
          input.value = "";
          return;
        }

        if (!muted) {
          socket.emit("message", msg);
          input.value = "";
        } else {
          alert("â›” ì±„íŒ…ì´ ê¸ˆì§€ë˜ì–´ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      document.getElementById("input").addEventListener("keydown", (e) => {
        if (e.key === "Enter") send();
      });

      document.addEventListener("click", (e) => {
        const menu = document.getElementById("userMenu");
        if (!menu.contains(e.target)) menu.style.display = "none";
      });
    </script>
  </body>
</html>
